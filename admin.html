<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n | Aquadama</title>
  <link rel="stylesheet" href="admin.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <script>
    if (sessionStorage.getItem("authToken") !== "authenticated") {
      alert("‚ö†Ô∏è Acceso no autorizado. Por favor, inicia sesi√≥n.");
      window.location.href = "index.html";
    }
  </script>

  <div class="sidebar">
    <h2>Aquadama</h2>
    <ul>
      <li><a href="#" id="nav-empleados">üìã Empleados</a></li>
      <li><a href="#" id="nav-usuarios">üë§ Administradores</a></li>
      <li><a href="#" id="nav-pass">üîí Cambiar Contrase√±a</a></li>
      <li><a href="#" id="logout">üö™ Cerrar Sesi√≥n</a></li>
    </ul>
  </div>

  <div class="main-content">
    <section id="panel-empleados">
      <h1>Empleados Registrados</h1>
      <div id="employeeList"></div>
    </section>

    <section id="panel-usuarios" class="hidden">
      <h1>Gesti√≥n de Administradores</h1>
      <form id="createAdminForm">
        <label>Nuevo Usuario:<input type="text" id="newAdminUser" required /></label>
        <label>Contrase√±a:<input type="password" id="newAdminPass" required /></label>
        <button type="submit">Crear Administrador</button>
      </form>
      <ul id="adminList"></ul>
    </section>

    <section id="panel-pass" class="hidden">
      <h1>Cambiar Contrase√±a</h1>
      <form id="changePassForm">
        <label>Contrase√±a Actual:<input type="password" id="currentPass" required /></label>
        <label>Nueva Contrase√±a:<input type="password" id="newPass" required /></label>
        <button type="submit">Cambiar</button>
      </form>
    </section>
  </div>

  <script>
    const admins = JSON.parse(localStorage.getItem("aquadama_admins") || "{}");
    const { jsPDF } = window.jspdf;

    document.getElementById("logout").addEventListener("click", () => {
      sessionStorage.removeItem("authToken");
      location.href = "index.html";
    });

    document.getElementById("nav-empleados").addEventListener("click", () => showPanel("panel-empleados"));
    document.getElementById("nav-usuarios").addEventListener("click", () => showPanel("panel-usuarios"));
    document.getElementById("nav-pass").addEventListener("click", () => showPanel("panel-pass"));

    function showPanel(id) {
      document.querySelectorAll(".main-content section").forEach(sec => sec.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function loadEmployeeList() {
      const list = document.getElementById("employeeList");
      list.innerHTML = "";
      
      const employees = JSON.parse(localStorage.getItem("aquadama_employees") || "[]");
      
      if (employees.length === 0) {
        list.innerHTML = "<p>No hay empleados registrados.</p>";
        return;
      }

      employees.forEach((emp, index) => {
        const card = document.createElement("div");
        card.className = "employee-card";
        card.innerHTML = `
          <h3>${emp.nombre} ${emp.apellidos} (ID: ${emp.id})</h3>
          <button onclick="toggleDetails(${emp.id})" id="toggle-btn-${emp.id}">üîΩ Ver Detalles</button>
          <button onclick="deleteEmployee(${index})">üóëÔ∏è Eliminar</button>
          <button onclick="generarPDF(${index})">üìÑ Generar PDF</button>
          <div id="details-${emp.id}" class="hidden" style="margin-top:10px;">
            <p><strong>DNI:</strong> ${emp.dni}</p>
            <p><strong>Fecha Nacimiento:</strong> ${emp.fechaNacimiento}</p>
            <p><strong>Nacionalidad:</strong> ${emp.nacionalidad}</p>
            <p><strong>Email:</strong> ${emp.email}</p>
            <p><strong>Tel√©fono:</strong> ${emp.telefono}</p>
            <p><strong>Direcci√≥n:</strong> ${emp.direccion}, ${emp.localidad}, ${emp.provincia} (${emp.cp})</p>
            <p><strong>Centro:</strong> ${emp.centro || '-'}</p>
            <p><strong>IBAN:</strong> ${emp.iban}</p>
            <p><strong>SS:</strong> ${emp.ss}</p>
            <div style="margin-top:10px;">
              ${emp.fotoDNIDelante ? `<button onclick="downloadFile('${emp.fotoDNIDelante}', 'DNI_Delante_${emp.id}.jpg')">üÜî DNI Delante</button>` : ''}
              ${emp.fotoDNIDetras ? `<button onclick="downloadFile('${emp.fotoDNIDetras}', 'DNI_Detras_${emp.id}.jpg')">üÜî DNI Detr√°s</button>` : ''}
              ${emp.fotoPersonal ? `<button onclick="downloadFile('${emp.fotoPersonal}', 'Foto_${emp.id}.jpg')">üì∏ Foto</button>` : ''}
              ${emp.firma ? `<button onclick="downloadFile('${emp.firma}', 'Firma_${emp.id}.png')">‚úçÔ∏è Firma</button>` : ''}
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    }

    function deleteEmployee(index) {
      if (confirm("¬øEliminar este empleado?")) {
        const employees = JSON.parse(localStorage.getItem("aquadama_employees") || "[]");
        employees.splice(index, 1);
        localStorage.setItem("aquadama_employees", JSON.stringify(employees));
        loadEmployeeList();
      }
    }

    function toggleDetails(id) {
      const section = document.getElementById("details-" + id);
      const btn = document.getElementById("toggle-btn-" + id);
      const hidden = section.classList.contains("hidden");
      section.classList.toggle("hidden");
      btn.textContent = hidden ? "üîº Ocultar Detalles" : "üîΩ Ver Detalles";
    }

    function downloadFile(dataUrl, filename) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function generarPDF(index) {
      const employees = JSON.parse(localStorage.getItem("aquadama_employees") || "[]");
      const emp = employees[index];
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("HOJA DE DATOS ¬∑ Trabajadores/as", 105, 15, null, null, "center");
      doc.setFontSize(10);
      doc.text("Los datos solicitados son los necesarios e inherentes a la relaci√≥n laboral y su correcto funcionamiento.", 105, 25, null, null, "center");

      const startY = 35;
      const lineHeight = 8;
      const col1X = 20;
      const col2X = 110;

      doc.setFont(undefined, "bold");
      doc.text("Nombre y apellidos:", col1X, startY);
      doc.text("DNI:", col2X, startY);
      doc.setFont(undefined, "normal");
      doc.text(`${emp.nombre} ${emp.apellidos}`, col1X, startY + lineHeight);
      doc.text(emp.dni, col2X, startY + lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("N√∫mero Seg. Social:", col1X, startY + 2 * lineHeight);
      doc.text("Nacionalidad:", col2X, startY + 2 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(emp.ss, col1X, startY + 3 * lineHeight);
      doc.text(emp.nacionalidad, col2X, startY + 3 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Sexo:", col1X, startY + 4 * lineHeight);
      doc.text("Fecha de nacimiento:", col2X, startY + 4 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text("", col1X, startY + 5 * lineHeight);
      doc.text(emp.fechaNacimiento, col2X, startY + 5 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Lugar:", col1X, startY + 6 * lineHeight);
      doc.text("Estado civil:", col2X, startY + 6 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text("", col1X, startY + 7 * lineHeight);
      doc.text(emp.estadoCivil || "", col2X, startY + 7 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("N√∫mero de hijos:", col1X, startY + 8 * lineHeight);
      doc.text("Tel√©fono/s:", col2X, startY + 8 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(emp.hijos || "", col1X, startY + 9 * lineHeight);
      doc.text(emp.telefono, col2X, startY + 9 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Email:", col1X, startY + 10 * lineHeight);
      doc.text("Formaci√≥n Oficial:", col2X, startY + 10 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(emp.email, col1X, startY + 11 * lineHeight);
      doc.text(emp.formacion || "", col2X, startY + 11 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Direcci√≥n:", col1X, startY + 12 * lineHeight);
      doc.text("C√≥digo postal:", col2X, startY + 12 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(emp.direccion, col1X, startY + 13 * lineHeight);
      doc.text(emp.cp, col2X, startY + 13 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Poblaci√≥n:", col1X, startY + 14 * lineHeight);
      doc.text("Provincia:", col2X, startY + 14 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(emp.localidad, col1X, startY + 15 * lineHeight);
      doc.text(emp.provincia, col2X, startY + 15 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Informaci√≥n Bancaria", col1X, startY + 17 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(`N√∫mero de cuenta - IBAN: ${emp.iban}`, col1X, startY + 18 * lineHeight);
      doc.setFont(undefined, "italic");
      doc.text("(En Espa√±a el IBAN consta de 24 posiciones comenzando siempre por ES)", col1X, startY + 19 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Contactos de Emergencia (Opcional)", col1X, startY + 21 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(`Nombre (Persona de contacto): ${emp.emergencia1 || ""}`, col1X, startY + 22 * lineHeight);
      doc.text(`Parentesco:`, col1X, startY + 23 * lineHeight);
      doc.text(`Tel√©fono:`, col1X, startY + 24 * lineHeight);

      doc.setFont(undefined, "bold");
      doc.text("Firma y Fecha", col1X, startY + 26 * lineHeight);
      doc.setFont(undefined, "normal");
      doc.text(`Fecha: ${emp.fechaRegistro}`, col1X, startY + 27 * lineHeight);

      if(emp.firma){
        const img = new Image();
        img.src = emp.firma;
        img.onload = () => {
          doc.addImage(img, "PNG", col1X, startY + 29 * lineHeight, 60, 30);
          addFooter(doc);
          doc.save(`Ficha_Empleado_${emp.id}.pdf`);
        };
      } else {
        addFooter(doc);
        doc.save(`Ficha_Empleado_${emp.id}.pdf`);
      }
    }

    function addFooter(doc) {
      doc.setFontSize(7);
      doc.text("*RECUERDE LA IMPORTANCIA DE COMUNICAR CUALQUIER VARIACI√ìN Y/O MODIFICACI√ìN DE DATOS*", 105, 280, null, null, "center");

      doc.setFontSize(6);
      doc.text("Informaci√≥n b√°sica sobre Protecci√≥n de Datos", 105, 285, null, null, "center");
      doc.text("RESPONSABLE: Tratamiento Integral Del Agua Aquadama, S.L.U. | FINALIDAD DEL TRATAMIENTO: Gesti√≥n inherente a la relaci√≥n laboral. | LEGITIMACI√ìN: Consentimiento del interesado/a e inter√©s leg√≠timo del Responsable.", 105, 290, {maxWidth: 180, align: "center"});
      doc.text("DESTINATARIOS: No se ceder√°n datos a terceros, salvo obligaci√≥n legal o cumplimiento de la normativa que resulte de aplicaci√≥n.", 105, 295, {maxWidth: 180, align: "center"});
      doc.text("DERECHOS: Usted podr√° solicitar el acceso, rectificaci√≥n y/o supresi√≥n de sus datos, as√≠ como otros derechos, como se explica en la informaci√≥n adicional.", 105, 300, {maxWidth: 180, align: "center"});
      doc.text("Puede consultar la informaci√≥n adicional y detallada sobre Protecci√≥n de Datos en:", 105, 305, {maxWidth: 180, align: "center"});
      doc.text("http://aquadama.avisolegal.info/RRHH-DATOS_TRABAJADOR-A/datos_trabajador-a.html", 105, 310, {maxWidth: 180, align: "center", link: "http://aquadama.avisolegal.info/RRHH-DATOS_TRABAJADOR-A/datos_trabajador-a.html"});
      doc.text("DELEGADO PROTECCI√ìN DE DATOS: Tratamiento Integral Del Agua Aquadama, S.L.U.", 105, 315, {maxWidth: 180, align: "center"});
      doc.text("Puede consultar la NORMATIVA VIGENTE DE PROTECCI√ìN DE DATOS PERSONALES en:", 105, 320, {maxWidth: 180, align: "center"});
      doc.text("http://normativa.avisolegal.info", 105, 325, {maxWidth: 180, align: "center", link: "http://normativa.avisolegal.info"});
    }

    document.getElementById("createAdminForm").addEventListener("submit", e => {
      e.preventDefault();
      const user = document.getElementById("newAdminUser").value.trim();
      const pass = document.getElementById("newAdminPass").value.trim();
      if (!user || !pass) return alert("‚ùó Rellena usuario y contrase√±a");
      if (admins[user]) return alert("‚ö†Ô∏è Usuario ya existe");
      admins[user] = pass;
      localStorage.setItem("aquadama_admins", JSON.stringify(admins));
      renderAdminList();
      e.target.reset();
      alert("‚úÖ Administrador creado");
    });

    document.getElementById("changePassForm").addEventListener("submit", e => {
      e.preventDefault();
      const current = document.getElementById("currentPass").value.trim();
      const newpass = document.getElementById("newPass").value.trim();
      const user = Object.keys(admins).find(u => admins[u] === current);
      if (!user) return alert("‚ùå Contrase√±a actual incorrecta");
      admins[user] = newpass;
      localStorage.setItem("aquadama_admins", JSON.stringify(admins));
      e.target.reset();
      alert("‚úÖ Contrase√±a actualizada");
    });

    function renderAdminList() {
      const list = document.getElementById("adminList");
      list.innerHTML = "";
      for (const user in admins) {
        const li = document.createElement("li");
        li.textContent = user;
        if (user !== "javierit") {
          const del = document.createElement("button");
          del.textContent = "‚ùå";
          del.onclick = () => {
            if (confirm(`¬øEliminar al admin '${user}'?`)) {
              delete admins[user];
              localStorage.setItem("aquadama_admins", JSON.stringify(admins));
              renderAdminList();
            }
          };
          li.appendChild(del);
        }
        list.appendChild(li);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      showPanel("panel-empleados");
      renderAdminList();
      loadEmployeeList();
    });
  </script>
</body>
</html>
